<!doctype html>
<html>
  <head>
    <title>SION2 HD</title>
    <meta name="theme-color" content="#333333">
    <meta charset="utf-8">
    <link rel="manifest" href="manifest.json">
    <link
        href="https://fonts.googleapis.com/css?family=Geo|Audiowide|Fira+Mono"
        rel="stylesheet">
    <!--
     Copyright 2016 Takashi Toyoshima <toyoshim@gmail.com>. All rights reserved.
     Use of this source code is governed by a BSD-style license that can be
     found in the LICENSE file.
    -->
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #000;
      }
      div {
        border: 0px none;
      }
      canvas {
        display: block;
        border: 0px none;
        position: absolute;
        left: 0px;
        top: 0px;
      }
    </style>
  </head>
  <body>
    <div>
      <canvas id="canvas0" style="z-index: 0;"></canvas>
      <canvas id="canvas1" style="z-index: 1;"></canvas>
      <canvas id="canvas2" style="z-index: 2;"></canvas>
      <canvas id="canvas3" style="z-index: 3;"></canvas>
    </div>
    <script type="text/javascript" charset="UTF-8" src="magic2.js"></script>
    <script type='text/javascript'>
      var audio = null;
      var asize = 1024;
      var asp = null;
      var abuffer = [];
      var abufs = 1;
      for (var i = 0; i < abufs; ++i)
        abuffer[i] = [new Float32Array(asize), new Float32Array(asize)];
      var aread = 0;
      var awrite = 0;
      var aready = 0;
      var arequest = 0;
      var zready = false;
      if (window['AudioContext']) {
        audio = new AudioContext();
        asp = audio.createScriptProcessor(asize, 2, 2);
        asp.addEventListener('audioprocess', function(e) {
          if (aready != 0) {
            var l = e.outputBuffer.getChannelData(0);
            var r = e.outputBuffer.getChannelData(1);
            var buf = abuffer[aread];
            aread = (aread + 1) % abufs;
            for (var i = 0; i < asize; ++i) {
              l[i] = buf[0][i];
              r[i] = buf[1][i];
            }
            aready--;
          }
          if (zready) {
            while ((aready + arequest) < abufs) {
              zmusic.postMessage({ type: 'update' });
              arequest++;
            }
          }
        }, false);
        asp.connect(audio.destination);
      }
      var zmusic = new Worker('worker_zmusic.js');
      var zmusicPromise = new Promise(function(resolve, reject) {
        zmusic.addEventListener('message', function(e) {
          var data = e.data;
          if (data.type == 'dos' && data.func == 'keepr' && data.code == 0) {
            if (audio) {
              zmusic.postMessage({
                type: 'init',
                rate: audio.sampleRate,
                count: asize,
                bufs: abufs
              });
              arequest = 0;
              zready = true;
            }
            resolve();
          } else if (data.type == 'update') {
            var buf = abuffer[awrite];
            awrite = (awrite + 1) % abufs;
            for (var i = 0; i < asize; ++i) {
              buf[0][i] = data.l[i]
              buf[1][i] = data.r[i]
            }
            aready++;
            arequest--;
          }
        });
      });
      var zmusicBind = {};
      window.zmusic_bind = function(address, name) {
        zmusicBind[address] = name;
      };
      window.zmusic_call = function(d1, d2, d3, d4, a1) {
        zmusic.postMessage({
          type: 'zmusic',
          d1: d1,
          d2: d2,
          d3: d3,
          d4: d4,
          a1: a1,
          zmd: zmusicBind[a1]
        });
      };
      document.fonts.load('10px Audiowide');
      document.fonts.load('10px \'Fira Mono\'');
      document.fonts.load('10px Geo');
      var canvas = document.getElementsByTagName('canvas');
      /* global Magic2 */
      var magic2 = new Magic2(Array.prototype.map.call(canvas, function(c) {
        // Changes canvas size to fullfill the window.
        c.width = window.innerWidth;
        c.height = window.innerHeight;
        return c.getContext('2d');
      }));
      var Module = {
        preRun: [],
        postRun: [],
        arguments: ['sion2/sion2.x'],
        print: function(text) {
          if (arguments.length > 1)
            text = Array.prototype.slice.call(arguments).join('\n');
          console.warn(text);
        },
        printErr: function(text) {
          if (arguments.length > 1)
            text = Array.prototype.slice.call(arguments).join('\n');
          console.error(text);
        },
        preInit: function() {
          Module.addRunDependency("zmusic");
          zmusicPromise.then(function() {
            Module.removeRunDependency("zmusic");
          });
          Module.addRunDependency("fonts");
          document.fonts.ready.then(function() {
            Module.removeRunDependency("fonts");
          });
        }
      };
    </script>
    <script type="text/javascript" charset="UTF-8" src="iocs.js"></script>
    <script type="text/javascript" charset="UTF-8" src="io.js"></script>
    <script type="text/javascript" charset="ShiftJIS" src="sion2.js"></script>
  </body>
</html>
